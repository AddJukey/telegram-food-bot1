import logging
import asyncio
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from config import Config
from roboflow_service import RoboflowFoodDetector
from openfoodfacts_service import OpenFoodFactsService

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
detector = RoboflowFoodDetector()
food_service = OpenFoodFactsService()


# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    welcome_text = """
üçï *Food Calorie Scanner* üçé

*–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:*
ü§ñ Roboflow AI - —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –µ–¥—ã –Ω–∞ —Ñ–æ—Ç–æ
üìä Open Food Facts - –±–∞–∑–∞ –∫–∞–ª–æ—Ä–∏–π
üöÄ Python + Telegram API

*–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*
1. –°–¥–µ–ª–∞–π—Ç–µ —á–µ—Ç–∫–æ–µ —Ñ–æ—Ç–æ –µ–¥—ã
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É
3. –ü–æ–ª—É—á–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏!

*–ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≥–æ, —á—Ç–æ –±–æ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç:*
üçé –Ø–±–ª–æ–∫–∏, –±–∞–Ω–∞–Ω—ã, –∞–ø–µ–ª—å—Å–∏–Ω—ã
üçï –ü–∏—Ü—Ü–∞, –±—É—Ä–≥–µ—Ä—ã, —Å—ç–Ω–¥–≤–∏—á–∏
ü•ó –°–∞–ª–∞—Ç—ã, –∫—É—Ä–∏—Ü–∞, —Ä—ã–±–∞
üçû –•–ª–µ–±, —Å—ã—Ä, —è–π—Ü–∞

*–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ. –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω—ã –≤–µ—Å—ã –∏ –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Ü–µ–ø—Ç–µ.

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –µ–¥—ã –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞! üì∏
"""
    await update.message.reply_text(welcome_text, parse_mode="Markdown")


# –ö–æ–º–∞–Ω–¥–∞ /help
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = """
üìã *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
/list - –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–µ–º—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
/test - –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É API

*–°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:*
1. –°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–∏ —Ö–æ—Ä–æ—à–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏
2. –ï–¥–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–Ω–∏–º–∞—Ç—å –±–æ–ª—å—à—É—é —á–∞—Å—Ç—å –∫–∞–¥—Ä–∞
3. –°—Ç–∞—Ä–∞–π—Ç–µ—Å—å —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω –≤–∏–¥ –µ–¥—ã
4. –ò–∑–±–µ–≥–∞–π—Ç–µ —Ä–∞–∑–º—ã—Ç—ã—Ö —Å–Ω–∏–º–∫–æ–≤

*–ß—Ç–æ –º–æ–∂–µ—Ç –±–æ—Ç:*
- –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–æ 36 –≤–∏–¥–æ–≤ –µ–¥—ã
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏
- –ü–æ–∫–∞–∑–∞—Ç—å –ë–ñ–£ (–±–µ–ª–∫–∏, –∂–∏—Ä—ã, —É–≥–ª–µ–≤–æ–¥—ã)
"""
    await update.message.reply_text(help_text, parse_mode="Markdown")


# –ö–æ–º–∞–Ω–¥–∞ /list
async def list_foods(update: Update, context: ContextTypes.DEFAULT_TYPE):
    food_list = """
üçΩ *–°–ø–∏—Å–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–µ–º—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤:*

*–§—Ä—É–∫—Ç—ã –∏ –æ–≤–æ—â–∏:*
üçé –Ø–±–ª–æ–∫–æ, üçå –ë–∞–Ω–∞–Ω, üçä –ê–ø–µ–ª—å—Å–∏–Ω, ü•ï –ú–æ—Ä–∫–æ–≤—å

*–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞:*
üçï –ü–∏—Ü—Ü–∞, üçî –ì–∞–º–±—É—Ä–≥–µ—Ä, ü•™ –°—ç–Ω–¥–≤–∏—á, üçó –ö—É—Ä–∏—Ü–∞, üêü –†—ã–±–∞

*–ì–∞—Ä–Ω–∏—Ä—ã:*
üçö –†–∏—Å, üçù –ü–∞—Å—Ç–∞, üçü –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏

*–ó–∞–≤—Ç—Ä–∞–∫–∏ –∏ –¥–µ—Å–µ—Ä—Ç—ã:*
üçû –•–ª–µ–±, ü•û –ë–ª–∏–Ω—ã, üßÄ –°—ã—Ä, üç∞ –¢–æ—Ä—Ç, üç™ –ü–µ—á–µ–Ω—å–µ

*–ù–∞–ø–∏—Ç–∫–∏:*
‚òï –ö–æ—Ñ–µ, üçµ –ß–∞–π, ü•õ –ú–æ–ª–æ–∫–æ

*–ò –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ!*
–í—Å–µ–≥–æ –±–æ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç 36 –≤–∏–¥–æ–≤ –µ–¥—ã.
"""
    await update.message.reply_text(food_list, parse_mode="Markdown")


# –ö–æ–º–∞–Ω–¥–∞ /test
async def test_api(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã API"""
    await update.message.reply_text("üîç –¢–µ—Å—Ç–∏—Ä—É—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API...")

    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É
    test_result = food_service.search_product("apple")

    if test_result:
        response = (
            "‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç!\n\n"
            "*–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã:*\n"
            f"üçé {test_result['name']}:\n"
            f"üî• {test_result['calories']} –∫–∫–∞–ª\n"
            f"ü•ö {test_result['protein']}–≥ –±–µ–ª–∫–æ–≤\n"
            f"ü•ë {test_result['fat']}–≥ –∂–∏—Ä–æ–≤\n"
            f"üçû {test_result['carbs']}–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤\n\n"
            "–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –µ–¥—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞!"
        )
    else:
        response = "‚ö†Ô∏è –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–Ω–µ—à–Ω–∏–º–∏ API"

    await update.message.reply_text(response, parse_mode="Markdown")


# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        status_msg = await update.message.reply_text(
            "üì• –ó–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ...",
            parse_mode="Markdown"
        )

        # –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ (—Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ)
        photo_file = await update.message.photo[-1].get_file()

        await status_msg.edit_text("üîÑ –°–∫–∞—á–∏–≤–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")

        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ –∫–∞–∫ bytes
        photo_bytes = await photo_file.download_as_bytearray()

        await status_msg.edit_text("ü§ñ –†–∞—Å–ø–æ–∑–Ω–∞—é –µ–¥—É –Ω–∞ —Ñ–æ—Ç–æ...")

        # –®–∞–≥ 1: –†–∞—Å–ø–æ–∑–Ω–∞–µ–º –µ–¥—É —á–µ—Ä–µ–∑ Roboflow
        food_items = detector.detect_food_from_bytes(photo_bytes)

        if not food_items:
            await status_msg.edit_text(
                "‚ùå *–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –µ–¥—É –Ω–∞ —Ñ–æ—Ç–æ*\n\n"
                "*–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:*\n"
                "‚Ä¢ –°–ª–∏—à–∫–æ–º —Ç–µ–º–Ω–æ–µ/—Ä–∞–∑–º—ã—Ç–æ–µ —Ñ–æ—Ç–æ\n"
                "‚Ä¢ –ï–¥–∞ –Ω–µ –≤ —Ñ–æ–∫—É—Å–µ\n"
                "‚Ä¢ –ü—Ä–æ–¥—É–∫—Ç –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Å–ø–∏—Å–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–µ–º—ã—Ö\n\n"
                "*–ß—Ç–æ –¥–µ–ª–∞—Ç—å:*\n"
                "1. –°–¥–µ–ª–∞–π—Ç–µ –±–æ–ª–µ–µ —á–µ—Ç–∫–æ–µ —Ñ–æ—Ç–æ\n"
                "2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ–¥–∞ —Ö–æ—Ä–æ—à–æ –≤–∏–¥–Ω–∞\n"
                "3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–∞–∫—É—Ä—Å\n"
                "4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /list —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –±–æ—Ç",
                parse_mode="Markdown"
            )
            return

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        detected_text = "\n".join(
            [f"‚Ä¢ {item['russian_name']} ({item['confidence']}%)"
             for item in food_items]
        )

        await status_msg.edit_text(
            f"‚úÖ *–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:*\n{detected_text}\n\n"
            f"üìä –ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–ª–æ—Ä–∏—è—Ö...",
            parse_mode="Markdown"
        )

        # –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–ª–æ—Ä–∏—è—Ö
        nutrition_info = food_service.get_nutrition_for_foods(food_items)

        # –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        if nutrition_info['count'] > 0:
            response = "üçΩ *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:*\n\n"

            for i, item in enumerate(nutrition_info['items'], 1):
                source_icon = "üì±" if item['source'] == 'local' else "üåê"
                response += (
                    f"*{i}. {item['name']}* {source_icon}\n"
                    f"   –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {item['confidence']}%\n"
                    f"   üî• *{item['calories']} –∫–∫–∞–ª*\n"
                    f"   ü•ö {item['protein']}–≥ –±–µ–ª–∫–æ–≤\n"
                    f"   ü•ë {item['fat']}–≥ –∂–∏—Ä–æ–≤\n"
                    f"   üçû {item['carbs']}–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤\n\n"
                )

            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥
            response += (
                f"üìà *–ü—Ä–∏–º–µ—Ä–Ω—ã–π –∏—Ç–æ–≥ –Ω–∞ 100–≥ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞:*\n"
                f"üî• *{nutrition_info['total']['calories']} –∫–∫–∞–ª*\n"
                f"ü•ö {round(nutrition_info['total']['protein'], 1)}–≥ –±–µ–ª–∫–æ–≤\n"
                f"ü•ë {round(nutrition_info['total']['fat'], 1)}–≥ –∂–∏—Ä–æ–≤\n"
                f"üçû {round(nutrition_info['total']['carbs'], 1)}–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤\n\n"
            )

            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—á–∞–Ω–∏—è
            response += (
                "‚ö†Ô∏è *–í–∞–∂–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è:*\n"
                "‚Ä¢ –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ –∏ –Ω–∞ 100–≥ –ø—Ä–æ–¥—É–∫—Ç–∞\n"
                "‚Ä¢ –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞–ª–æ—Ä–∏–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ä–µ—Ü–µ–ø—Ç–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Ä—Ü–∏–∏\n"
                "‚Ä¢ –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—É—Ö–æ–Ω–Ω—ã–µ –≤–µ—Å—ã\n"
                "‚Ä¢ –ë–æ—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø—Ä–∏–º–µ—Ä–Ω–æ–π –æ—Ü–µ–Ω–∫–∏\n\n"
                "‚úÖ *–ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:*\n"
                "‚Ä¢ –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Ä—Ü–∏–∏\n"
                "‚Ä¢ –£—á–µ—Å—Ç—å —Å–ø–æ—Å–æ–± –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è\n"
                "‚Ä¢ –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –±–∞–∑—É"
            )
        else:
            response = (
                "‚ùå *–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–ª–æ—Ä–∏—è—Ö*\n\n"
                "*–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã:*\n"
                f"{detected_text}\n\n"
                "*–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:*\n"
                "1. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É\n"
                "2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ —Ç–µ–∫—Å—Ç–æ–º\n"
                "3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /list —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã"
            )

        await status_msg.edit_text(response, parse_mode="Markdown")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ: {e}")
        await update.message.reply_text(
            "‚ùå *–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ*\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
            "1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start\n"
            "2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ\n"
            "3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\n\n"
            f"*–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:* {str(e)[:100]}",
            parse_mode="Markdown"
        )


# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞)
async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_text = update.message.text.strip().lower()

    if len(user_text.split()) > 5:
        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω—ã–π, –≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
        await update.message.reply_text(
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Ñ–æ—Ç–æ –µ–¥—ã –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '—è–±–ª–æ–∫–æ' –∏–ª–∏ '–ø–∏—Ü—Ü–∞')",
            parse_mode="Markdown"
        )
        return

    # –ò—â–µ–º –ø—Ä–æ–¥—É–∫—Ç –≤ –±–∞–∑–µ
    nutrition = food_service.search_product(user_text)

    if nutrition and nutrition.get('success', True):
        source_text = {
            'local': 'üì± (–ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞)',
            'openfoodfacts': 'üåê (Open Food Facts)',
            'estimated': '‚ö° (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)'
        }.get(nutrition.get('source', ''), '')

        response = (
            f"üìä *{nutrition['name'].capitalize()}* {source_text}\n\n"
            f"*–ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 100–≥:*\n"
            f"üî• *{nutrition['calories']} –∫–∫–∞–ª*\n"
            f"ü•ö {nutrition['protein']}–≥ –±–µ–ª–∫–æ–≤\n"
            f"ü•ë {nutrition['fat']}–≥ –∂–∏—Ä–æ–≤\n"
            f"üçû {nutrition['carbs']}–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤\n\n"
            f"*–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*\n"
            f"1. –í–∑–≤–µ—Å—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ç\n"
            f"2. –†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ: (–≤–µ—Å/100) √ó {nutrition['calories']}\n"
            f"3. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ—á–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏\n\n"
            f"*–ü—Ä–∏–º–µ—Ä:* 250–≥ –ø—Ä–æ–¥—É–∫—Ç–∞ = {nutrition['calories'] * 2.5} –∫–∫–∞–ª"
        )
    else:
        response = (
            f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ '{user_text}'\n\n"
            f"*–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:*\n"
            "‚Ä¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–∞\n"
            "‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ\n"
            "‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: /list"
        )

    await update.message.reply_text(response, parse_mode="Markdown")


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.error(f"Update {update} caused error {context.error}")

    try:
        await update.message.reply_text(
            "üòï *–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫*\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
            "1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –µ—â–µ —Ä–∞–∑\n"
            "2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /start\n"
            "3. –ü–æ–¥–æ–∂–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç\n\n"
            "–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, —Å–æ–æ–±—â–∏—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.",
            parse_mode="Markdown"
        )
    except:
        pass


# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
    if not Config.TELEGRAM_TOKEN:
        print("‚ùå –û—à–∏–±–∫–∞: TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
        print("–î–æ–±–∞–≤—å—Ç–µ TELEGRAM_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω –≤ —Ñ–∞–π–ª .env")
        return

    if not Config.ROBOFLOW_API_KEY:
        print("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: ROBOFLOW_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω. –ë–æ—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É.")

    # –°–æ–∑–¥–∞–µ–º Application
    application = Application.builder().token(Config.TELEGRAM_TOKEN).build()

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("list", list_foods))
    application.add_handler(CommandHandler("test", test_api))
    application.add_handler(MessageHandler(filters.PHOTO, handle_photo))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    application.add_error_handler(error_handler)

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    print("üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:")
    print("   ‚Ä¢ Telegram Bot API")
    print("   ‚Ä¢ Roboflow AI (—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –µ–¥—ã)")
    print("   ‚Ä¢ Open Food Facts (–±–∞–∑–∞ –∫–∞–ª–æ—Ä–∏–π)")
    print("   ‚Ä¢ –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤")
    print("\nüì± –¢–µ–ø–µ—Ä—å –±–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    print("   –û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –≤ Telegram —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å")

    application.run_polling(allowed_updates=Update.ALL_TYPES)


if __name__ == '__main__':
    main()